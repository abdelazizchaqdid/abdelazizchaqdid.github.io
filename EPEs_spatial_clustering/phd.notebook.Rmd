---
title: "Regional clustering of extreme precipitation in Morocco"
output: html_notebook
---
loading the necessary libraries 
```{r}
library(ncdf4)
library(raster)
library(ggplot2)
library(cowplot)
library(tidyverse)
library(TTR)
library(caTools)
library(rgeos)
library(splancs)
library(rgdal)
library(sf)
library(extrafont)
library(rgdal)
library(ggsn)
library(cluster)
library(maps)
library(RColorBrewer)
library(viridis)
library(factoextra)
library(reshape2)
library(ggpubr)
library(xts)
library(rnaturalearthdata)
library(rnaturalearth)
library(gtable)  # 
library(grid)
library(scales)
library(reshape2)
library(scico)
library(ggthemes)
library(paletteer)
library(metR)
library(thematic)
library(patchwork)
library(mousetrap)
library(openair)
```
### 1- define the clusters using a modified version  of bernard et.al (2013) approach
```{r}
## prepare precipitation data
setwd("C:/Users/abdel/OneDrive/Desktop/Extreme Rainfall events in Morocco/data/ERA5/precipitation0.25")
RR.days <- brick("ERA5_daily_precipitation_1979-2021_Morocco.nc")
b.df <- RR.days %>%
  rasterToPoints %>%
  as.data.frame() %>% `colnames<-`(c("x", "y", names(RR.days)))
rownames(b.df)<- paste0("x",b.df$x,"x", b.df$y)
b.df <- b.df[, -c(1, 2)]
b.df <- round(b.df*10^3, 1)
Tb.df <- t(b.df)
Coordinates <- colnames(Tb.df)
Tb.df <- cbind(year=as.numeric(substr(rownames(Tb.df),2,6)),
               month=as.numeric(substr(rownames(Tb.df),7,8)),
               Tb.df) %>% data.frame
colnames(Tb.df) <- c("year", "month", Coordinates)
## cluster grid points
# compute the annual maxima
RR.day <- Tb.df 
aux <- cbind(RR.day[,1:2], value=RR.day[,3])
RR.year <- aux %>% group_by(year) %>% 
  summarise(max(value))
for (name in colnames(RR.day)[-c(1:3)]) {
  aux <- cbind(RR.day[,1:2], value=RR.day[,name])
  aux <- aux %>% group_by(year) %>% summarise(RR=max(value))
  RR.year[,name]= aux$RR
}
colnames(RR.year)[3] <- names(RR.day)[3]
# compute f-madogram distance
x = RR.year[,-c(1)] %>% data.frame
Nnb = ncol(x)
Tnb = nrow(x)
V = array(NaN, dim = c(Tnb, Nnb))
for (p in 1:Nnb) {
  x.vec = as.vector(x[, p])
  x.vec[x.vec < 0] = NA
  Femp = ecdf(x.vec)(x.vec)
  V[, p] = Femp
}
dis.data = dist(t(V), method = "manhattan", diag = TRUE, 
                upper = TRUE)/(2 * Tnb)
# Hierarchical cultering
donn.class<- hclust(dis.data, method="ward.D2")
clusters= cutree(donn.class, 6)
clusters[which(clusters==6)] <- 5

```
Dendrogram of grid   
```{r}
k=6 # nombre declass 
p1 <- fviz_dend(donn.class , cex = 0.6, k = k,
                color_labels_by_k = TRUE, k_colors=  c("#5AFF00", "#8E01FE", "#0096FF", "#FFFE33", "#E60002", "#848484"),
                main = c("Dendrogram of grid points"), show_labels = FALSE,
                lwd = 0.6)+
    geom_hline(yintercept =0.85, col="white", size=4)+theme_classic()
setwd("D:/Phd/data/")
# png(paste("dendrogram.png"), width=8, height=5, units="in", res=400)#width=22, height=5
ggsave("dendrogram.pdf", width=8, height=4, units="in", dpi = 300, device=cairo_pdf)
p1
```
Cluster mapping 
```{r}
  setwd("D:/Phd/data/")
  # prepare clusters polygons
  xyc = list()
  for (ck in 1:5) {
    p= readOGR("D:/Phd/data/clusters shepfile/cluster5k", paste0("cluster",ck))
    ## start here for polys
    lin <- as(p, "SpatialLinesDataFrame")  
    #2. convert to matrix 
    mpts <- raster::geom(p)
    #3. convert to data frame
    dpts <- ggplot2::fortify(p)
    colnames(dpts) <- c("x",  "y",   "order", "hole",  "piece", "id",    "group")
    #4. convert to data frame
    ## names are   object_ branch_ island_ order_        x_       y_
    xyc[[ck]]=dpts
  }
  # loading coordinates
  longitudes =NULL
  latitudes  =NULL
  for (point in Coordinates) {
    longitudes[point]= strsplit(point, "x")[[1]][2]
    latitudes[point]= strsplit(point, "x")[[1]][3]
  }
  longitudes=as.numeric(longitudes)
  latitudes=as.numeric(latitudes)
  # Moroccan borders
  maroc <- st_read("D:/Phd/data/Morocco")
  # ploting 
  p1 <-plot.hclust(6,6)
  p1 <- p1+
    geom_polygon(data=xyc[[1]], aes(x=x, y=y), fill=NA, colour="black", size = 0.2)+
    geom_polygon(data=xyc[[2]], aes(x=x, y=y), fill=NA, colour="black", size = 0.2)+
    geom_polygon(data=xyc[[3]], aes(x=x, y=y), fill=NA, colour="black", size = 0.2)+
    geom_polygon(data=xyc[[4]], aes(x=x, y=y), fill=NA, colour="black", size = 0.2)+
    geom_polygon(data=xyc[[5]], aes(x=x, y=y), fill=NA, colour="black", size = 0.2)+
    theme(legend.text = element_text(size=11),
          legend.title = element_text(size=12),
          panel.grid.major = element_blank(),
          axis.text = element_text(size=7),
          axis.title = element_text(size=10)
          )+guides(colour = guide_legend(override.aes = list(size=1.4)))+
    north(maroc, scale = 0.08, symbol = 3, anchor = c(x=-15.5, y=36.3))

  setwd("D:/Phd/data")
  ggsave("Morocco_regionalization.pdf", p1, units="cm", width=11, height=9, device = cairo_pdf)
  
```

### Probability of simultaneous occurrence of extreme events inside and outside the cluster
```{r}
  setwd("D:/Phd/data/")
  p <-probability(b.df, K=6, clusters=clusters)
  p2 <- p[[1]]
  
  ggarrange(p2[[1]], p2[[2]], p2[[3]], p2[[4]], p2[[5]],p2[[6]],
            # p3[[1]], p3[[2]], p3[[3]], p3[[4]], p3[[5]],
            ncol=3, nrow = 2, common.legend = T, 
            legend = "bottom")
  # adding a legend
  setwd("D:/Phd/data")
  ggsave(paste0("proba.5k.pdf"), units="cm", width=18, height=14, device = cairo_pdf)
```

### Using extreme precipitation ocurrence probability, computed using observed data, to further validate clustering results

loading observed data to obs.list object
```{r}
setwd("D:/Phd/data/Tuel database")
nfiles <- list.files()
obs.list = list()
for (i in 1:length(nfiles)) {
  df <- read.table(nfiles[i], skip = 1, header = T, sep =' ', na="-999")[,1:2]
  df <- df [!is.na(df$p),]
  obs.list[[i]] <- df[!is.na(df$p),]
}
```

Assign stations to the pre-established clusters 
```{r}
 xyc = list()
  for (ck in 1:4) {
    p= readOGR("D:/Phd/data/clusters shepfile/cluster4k", paste0("cluster",ck))
    ## start here for polys
    lin <- as(p, "SpatialLinesDataFrame")  
    #2. convert to matrix 
    mpts <- raster::geom(p)
    #3. convert to data frame
    dpts <- ggplot2::fortify(p)
    colnames(dpts) <- c("x",  "y",   "order", "hole",  "piece", "id",    "group")
    #4. convert to data frame
    ## names are   object_ branch_ island_ order_        x_       y_
    xyc[[ck]]=dpts
  }
     
  setwd("D:/Phd/data/Tuel database")
  longitudes =NULL
  latitudes  =NULL
  for (i in 1:length(nfiles)) {
      aux <- read.csv(nfiles[i], header = F, sep = " ", nrows = 1)
      longitudes[i] = aux[[length(aux)-2]]
      latitudes[i] = aux[[ncol(aux)-1]]
  }
  coords <- data.frame(x=longitudes, y=latitudes)
    
  station.clustered=data.frame(station= "station", cluster="cluster")
  for (ck in 1:4) {
    station.clusters<- inout(as.points(x=coords[,1], y=coords[,2]),as.points(xyc[[ck]]) ) 
    station=rownames(coords[station.clusters,])
    cluster=rep(ck, length(station))
    station.clustered = rbind(station.clustered, cbind(station, cluster))
  }
  station.clustered <- station.clustered[-1,]
```
Quantiles preparation 
```{r}
setwd("D:/Phd/data/Tuel database")
quantiles = NULL
N.x.events <- NULL
for (i in 1:length(obs.list)) {
  df.obs=obs.list[[i]]
  df.obs=df.obs %>% mutate(yr=substr(date,1,4)) 
  per.day <- df.obs%>% group_by(yr) %>% dplyr::summarise(n=n()/365)
  gd.year <- per.day[per.day$n>0.9,]
  for (yr in gd.year$yr) {
    df.obs$yr[df.obs$yr==yr] <-1
  }
  df.obs$yr[ df.obs$yr!=1]=0
  gd.obs <- df.obs[df.obs$yr==1,]
  gd.obs$p <- runSum(gd.obs$p,3)
  gd.obs <- gd.obs[-c(1:2),]
  quantiles <- c(quantiles,quantile(gd.obs$p[gd.obs$p>=1], 0.95))
  N.x.events <- c(N.x.events, gd.obs$p[gd.obs$p> quantiles[i]]%>% length())
}
quantiles<- quantiles %>% as.numeric(quantiles)

```
Slice complete subperiods of time series and compute extreme events for each station
```{r}
# execute the related functions at the bottom before running this block
obs.ext.list = list()
for (i in 1:length(obs.list)) {
  df <- obs.list[[i]]
  df <- cbind( df, id=c(diff(as.Date( df[,1])),1))
  df <- slice.data(df)
  row.gd <- which(unlist(lapply(df, function(x){nrow(x)}))>=3)
  df  <- df[row.gd]
  slice.ext <- list()
  for (j in 1:length(df)) {
    df.ext <- data.frame(date=df[[j]][-c(1:2),1], p=runSum(df[[j]][,2], 3)[-c(1:2)]%>%round(2))
    df.ext$p <- as.numeric(df.ext$p > quantiles[i]) 
    slice.ext[[j]] <- df.ext
  }
  obs.ext.list[[i]] <- slice.ext
}
```
Compute probabilities 

```{r}
P <- list()
stations <- 1:length(obs.ext.list)
for (ck in 1:4) {
  ck.stations <- (station.clustered %>% filter(cluster==ck))[,1]
  Pij= stations
  for(st.i in as.numeric(ck.stations)){
    sliced.data.i <-  obs.ext.list[[st.i]]
    Psli=NULL
    for(st.j in stations){
        sliced.data.j <-  obs.ext.list[[st.j]]
        Pslij=NULL
        cardinalS=0
        for (sl.i in 1:length(sliced.data.i)) {
            slice.i =sliced.data.i[[sl.i]]
            Pe= NULL
            for (sl.j in 1:length(sliced.data.j)) {
              slice.j =sliced.data.j[[sl.j]]
              # intersection of dates
              inter.dates <- intersect(slice.i[,1], slice.j[,1])
              if(length(inter.dates)!=0){
              comn.slice.i <- slice.i[slice.i$date %in% inter.dates,]
              rownames(comn.slice.i) <- 1: nrow(comn.slice.i)
              comn.slice.j <- slice.j[slice.j$date %in% inter.dates,]
              rownames(comn.slice.j) <- 1: nrow(comn.slice.j)
              ekil.date <- which(comn.slice.i$p == 1)
              cardinalE = length(ekil.date)
              if( cardinalE != 0){
                cardinalS= cardinalS + cardinalE
                Pek <- NULL
                for (l in 1:cardinalE) {
                  DATE =ekil.date[l]
                  ekjl<- comn.slice.j[rownames(comn.slice.j)==(DATE-3) | rownames(comn.slice.j)==(DATE-2) | rownames(comn.slice.j)==(DATE-1) |
                                  rownames(comn.slice.j)==DATE |
                                  rownames(comn.slice.j)==(DATE+1) | rownames(comn.slice.j)==(DATE+2) | rownames(comn.slice.j)==(DATE+3),]
                  ekjl <- ceiling(sum(as.numeric(ekjl$p))/7)
                  Pek <- c(Pek, ekjl)
                }
                Pe<- c(Pe, sum(Pek, na.rm = T))
              }
            }else{Pe <- c(Pe, NA)}
            
          }
          Pslij <- c(Pslij, sum(Pe , na.rm = T))
        }
        Psli <- c(Psli, sum(Pslij , na.rm = T)/cardinalS)
    }
    Pij <- rbind(Pij,Psli)
    print(st.i)
  }
  Pij <- Pij[-c(1),]
  P[[ck]] <-   apply(Pij, 2,function(x){return(round(mean(x , na.rm = T),5))})
  cat("\n cluster : ", ck, "\n")
}
setwd("D:/Phd/data")
# write_rds(P, "conditional.probability.station.4k.rds")
```
Mapping the average conditional probability 
```{r}
  maroc <- st_read("D:/Phd/data/Morocco")
  p2= list()
  colbr=inferno(6)[-c(1)]
  for (ck in 1:4) {
    pMAX =sapply(P[[ck]], max) %>% max 
    pMIN =sapply(P[[ck]], min) %>% min 
    
    df.p <- data.frame(x= coords$x, y=coords$y, p=P[[ck]])
    df.p$vtitle <- paste0("Cluster  ", ck)
    df.p$htitle <- "Observations"
    p<-ggplot()+
    geom_sf(data= maroc, fill = "#552277", colour = "#552277", size=0.7)+
    geom_polygon(data=xyc[[ck]], aes(x=x, y=y), fill=NA, colour="black", size = 1.2)+
    geom_point(data = df.p, aes(x=x, y=y, fill=p), shape = 21, size=2, colour="black")+
    binned_scale(aesthetics = "fill",
                   scale_name = "stepsn", 
                   palette = function(x) inferno(6)[-c(1)],
                   breaks = c(0.15,0.3,0.45,0.6,0.75),
                   limits = c(pMIN, pMAX),
                   show.limits = F, 
                   guide = guide_colorbar(nbin = 5,
                                                barwidth = 25,
                                                title.position = "top",
                                                title.hjust = 0.5, 
                                                raster = FALSE,
                                                ticks = FALSE)
      )+
      labs(fill="Probability")+theme_grey()+
      theme(legend.text = element_text(size=14), 
            legend.title = element_text(size=16), 
            plot.title = element_text(hjust = 0.5, size=20, face="plain"),
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            axis.text = element_blank(),
            axis.ticks = element_blank(),
            axis.title = element_blank(),
            legend.position = "bottom",
            legend.key.size = unit(0.2, 'cm'),  
            legend.key.width= unit(5, 'cm'),
            strip.text.x = element_text(size = 18),
            strip.text.y = element_text(size = 18)
            )
    
    if(ck==4){p2[[ck]] <- p + facet_grid(htitle ~ vtitle)} else{p2[[ck]] <- p + facet_grid(. ~ vtitle)}
  }

  ggarrange(p2[[1]], p2[[2]], p2[[3]], p2[[4]],  p2[[5]], ncol=4, nrow=1, common.legend = T, legend = "bottom")
  # adding a legend
  setwd("D:/Phd/data")
  ggsave(paste0("proba.station.5k.tiff"), units="in", width=16, height=5, dpi=200, compression = 'lzw')
  

```
### Analysis of atmospheric conditions anomalies 

Load the necessary data 
```{r}
# load events
events <- read.csv("C:/Users/abdelaziz.chaqdid/Desktop/Phd/data/events/datailed.events.cluster.v2.csv", header = T, sep=";")
events <- events[-which(as.Date(events$date, format="%Y.%m.%d") >as.Date("2018-12-31")),]


maroc <- st_read("C:/Users/abdelaziz.chaqdid/Desktop/Phd/data/Morocco")
setwd("C:/Users/abdelaziz.chaqdid/Desktop/Phd/data")

ncfnames <- list.files("ERA5 reanalysis for extreme precipitation")
ncfnames <- paste0("ERA5 reanalysis for extreme precipitation/", ncfnames)

dname <- "sst"
b.sst <- brick(ncfnames[1], dname)
dname <- "Cyclone"
b.cyclone <- brick(ncfnames[2], dname)
dname <- "blocks"
b.blocks <- brick(ncfnames[3], dname)
dname <- "v_ivt"
b.v_ivt <- brick(ncfnames[4], dname)
names(b.v_ivt) <- seq(as.Date("1979-01-01"), length.out=14975, by="days")
dname <- "u_ivt"
b.u_ivt <- brick(ncfnames[5], dname)
names(b.u_ivt) <- seq(as.Date("1979-01-01"), length.out=14975, by="days")
dname <- "pv"
b.pv <- brick(ncfnames[6], dname)
dname <- "tcw"
b.tcw <- brick(ncfnames[7], dname)
dname <- "wspd"
b.wspd <- brick(ncfnames[8], dname)
dname <- "z"
b.z <- brick(ncfnames[9], dname)

anomalies.list <- list()
setwd("C:/Users/abdelaziz.chaqdid/Desktop/Phd/data/events/cluster anomalies")
for (ck in 1:5) {
  ck.sst =0
  ck.z =0
  ck.z2 =0
  ck.wspd=0
  ck.mslp=0
  ck.u_ivt=0
  ck.v_ivt=0
  ck.ivt=0
  ck.tcw=0
  ck.cyclone=0
  ck.pv=0
  ck.blocks=0
  ck.events <- events %>% filter(cluster==ck)
  # cluster limits
  # loading coordinates
  clusters= cutree(donn.class,k=6)
  clusters[which(clusters==6)] <- 5
  clusters.df <- data.frame(b.df, cluster= clusters)
  Coordinates= rownames(clusters.df %>% filter(cluster==ck) )
  longitudes =NULL
  latitudes  =NULL
  for (point in Coordinates) {
    longitudes[point]= strsplit(point, "x")[[1]][2]
    latitudes[point]= strsplit(point, "x")[[1]][3]
  }
  longitudes=as.numeric(longitudes)
  latitudes=as.numeric(latitudes)
  xyc=data.frame(x=longitudes, y=latitudes, z=rep(ck, length(longitudes)))

  # Morocco's map

  e <- extent(-90, 90, 5, 80)
  for(date in ck.events$dates){
    # compute the sst anomaly
    dt <- which(names(b.sst)==paste0("X",date))
    mean.sst <- stackApply(b.sst[[c((dt-2):dt)]], rep(1,length(3)), mean, na.rm=F)
    yr=substr(date, 1,4); m.d=substr(date, 5, 10)
    yrs <- unique(substr(names(b.sst), 2,5))
    dates <- sapply(paste0("X",yrs[!yrs==yr],m.d),
                    function(x){which(names(b.sst)==x)})
    ids <- sort(unique(union(union(dates,dates-1), dates-2)))
    climato.sst <- stackApply(b.sst[[ids]], rep(1,length(3)), mean, na.rm=F)
    mean.sst <- mean.sst -climato.sst
    mean.sst <- crop(mean.sst, e)
    df.sst <- cbind(xyFromCell(mean.sst, 1:ncell(mean.sst)), values(mean.sst)) %>% data.frame()
    colnames(df.sst) <- c("x", "y", "layer")

    # compute the cyclone anomaly
    names(b.cyclone) <- seq(as.Date("1979-01-01"), length.out=14610, by="days")
    dt <- which(names(b.cyclone)==paste0("X",date))
    mean.cyclone <- stackApply(b.cyclone[[c((dt-2):dt)]], rep(1,length(3)), mean, na.rm=F)
    yr=substr(date, 1,4); m.d=substr(date, 5, 10)
    yrs <- unique(substr(names(b.cyclone), 2,5))
    dates <- sapply(paste0("X",yrs[!yrs==yr],m.d),
                    function(x){which(names(b.cyclone)==x)})
    ids <- sort(unique(union(union(dates,dates-1), dates-2)))
    climato.cyclone<- stackApply(b.cyclone[[ids]], rep(1,length(ids)), mean, na.rm=F)
    mean.cyclone <- mean.cyclone - climato.cyclone
    mean.cyclone <- crop(mean.cyclone, e, snap='in')
    df.cyclone <- cbind(xyFromCell(mean.cyclone, 1:ncell(mean.cyclone)), values(mean.cyclone)) %>% data.frame()
    colnames(df.cyclone) <- c("x", "y", "layer")

    # compute the blocks anomaly
    dt <- which(names(b.blocks)==paste0("X",date))
    mean.blocks<- stackApply(b.blocks[[c((dt-2):dt)]], rep(1,length(3)), mean, na.rm=F)
    yr=substr(date, 1,4); m.d=substr(date, 5, 10)
    yrs <- unique(substr(names(b.blocks), 2,5))
    dates <- sapply(paste0("X",yrs[!yrs==yr],m.d),
                    function(x){which(names(b.blocks)==x)})
    ids <- sort(unique(union(union(dates,dates-1), dates-2)))
    climato.blocks<- stackApply(b.blocks[[ids]], rep(1,length(ids)), mean, na.rm=F)
    mean.blocks <- mean.blocks - climato.blocks
    mean.blocks <- crop(mean.blocks, e, snap='in')
    df.blocks <- cbind(xyFromCell(mean.blocks, 1:ncell(mean.blocks)), values(mean.blocks)) %>% data.frame()
    colnames(df.blocks) <- c("x", "y", "layer")

    # compute the PV anomaly
    names(b.pv) <- seq(as.Date("1979-01-01"), length.out=14975, by="days")
    dt <- which(names(b.pv)==paste0("X",date))
    mean.pv<- stackApply(b.pv[[c((dt-2):dt)]], rep(1,length(3)), mean, na.rm=F)
    yr=substr(date, 1,4); m.d=substr(date, 5, 10)
    yrs <- unique(substr(names(b.pv), 2,5))
    dates <- sapply(paste0("X",yrs[!yrs==yr],m.d),
                    function(x){which(names(b.pv)==x)})
    ids <- sort(unique(union(union(dates,dates-1), dates-2)))
    climato.pv <- stackApply(b.pv[[ids]], rep(1,length(ids)), mean)
    mean.pv <- mean.pv - climato.pv
    mean.pv <- crop(mean.pv, e, snap='in')
    df.pv <- cbind(xyFromCell(mean.pv, 1:ncell(mean.pv)), values(mean.pv)) %>% data.frame()
    colnames(df.pv) <- c("x", "y", "layer")

    # compute the tcw anomaly
    names(b.tcw) <- seq(as.Date("1979-01-01"), length.out=14975, by="days")
    dt <- which(names(b.tcw)==paste0("X",date))
    mean.tcw<- stackApply(b.tcw[[c((dt-2):dt)]],rep(1,length(3)), mean, na.rm=F)
    yr=substr(date, 1,4); m.d=substr(date, 5, 10)
    yrs <- unique(substr(names(b.tcw), 2,5))
    dates <- sapply(paste0("X",yrs[!yrs==yr],m.d),
                    function(x){which(names(b.tcw)==x)})
    ids <- sort(unique(union(union(dates,dates-1), dates-2)))
    climato.tcw<- stackApply(b.tcw[[ids]], rep(1,length(ids)), mean, na.rm=F)
    mean.tcw <- mean.tcw - climato.tcw
    mean.tcw <- crop(mean.tcw, e, snap='in')
    df.tcw <- cbind(xyFromCell(mean.tcw, 1:ncell(mean.tcw)), values(mean.tcw)) %>% data.frame()
    colnames(df.tcw) <- c("x", "y", "layer")

    # compute the wspd anomaly
    names(b.wspd) <- seq(as.Date("1979-01-01"), length.out=14975, by="days")
    dt <- which(names(b.wspd)==paste0("X",date))
    mean.wspd<- stackApply(b.wspd[[c((dt-2):dt)]], rep(1,length(3)), mean, na.rm=F)
    yr=substr(date, 1,4); m.d=substr(date, 5, 10)
    yrs <- unique(substr(names(b.wspd), 2,5))
    dates <- sapply(paste0("X",yrs[!yrs==yr],m.d),
                    function(x){which(names(b.wspd)==x)})
    ids <- sort(unique(union(union(dates,dates-1), dates-2)))
    climato.wspd<- stackApply(b.wspd[[ids]], rep(1,length(ids)), mean, na.rm=F)
    mean.wspd <- mean.wspd - climato.wspd
    mean.wspd <- crop(mean.wspd, e, snap='in')
    df.wspd <- cbind(xyFromCell(mean.wspd, 1:ncell(mean.wspd)), values(mean.wspd)) %>% data.frame()
    colnames(df.wspd) <- c("x", "y", "layer")

    # compute the Z
    dt <- which(names(b.z)==paste0("X",date))
    mean.z<- stackApply(b.z[[c((dt-2):dt)]], rep(1,length(3)), mean, na.rm=F)
    yr=substr(date, 1,4); m.d=substr(date, 5, 10)
    yrs <- unique(substr(names(b.z), 2,5))
    dates <- sapply(paste0("X",yrs[!yrs==yr],m.d),
                    function(x){which(names(b.z)==x)})
    ids <- sort(unique(union(union(dates,dates-1), dates-2)))
    climato.z<- stackApply(b.z[[ids]], rep(1,length(ids)), mean, na.rm=F)
    mean.z <- mean.z - climato.z
    mean.z <- crop(mean.z, e, snap='in')
    df.z <- cbind(xyFromCell(mean.z, 1:ncell(mean.z)), values(mean.z)) %>% data.frame()
    colnames(df.z) <- c("x", "y", "layer")

    # compute the IVT
    dt <- which(names(b.v_ivt)==paste0("X",date))
    mean.u_ivt<- stackApply(b.u_ivt[[c((dt-2):dt)]], rep(1,length(3)), mean, na.rm=F)
    yr=substr(date, 1,4); m.d=substr(date, 5, 10)
    yrs <- unique(substr(names(b.u_ivt), 2,5))
    dates <- sapply(paste0("X",yrs[!yrs==yr],m.d),
                    function(x){which(names(b.u_ivt)==x)})
    ids <- sort(unique(union(union(dates,dates-1), dates-2)))
    climato.u_ivt<- stackApply(b.u_ivt[[ids]], rep(1,length(ids)), mean, na.rm=F)
    mean.u_ivt <- mean.u_ivt - climato.u_ivt
    df.u_ivt <- cbind(xyFromCell(mean.u_ivt, 1:ncell(mean.u_ivt)), values(mean.u_ivt)) %>% data.frame()
    colnames(df.u_ivt) <- c("x", "y", "layer")

    mean.v_ivt<- stackApply(b.v_ivt[[c((dt-2):dt)]], rep(1,length(3)), mean, na.rm=F)
    yr=substr(date, 1,4); m.d=substr(date, 5, 10)
    yrs <- unique(substr(names(b.v_ivt), 2,5))
    dates <- sapply(paste0("X",yrs[!yrs==yr],m.d),
                    function(x){which(names(b.v_ivt)==x)})
    ids <- sort(unique(union(union(dates,dates-1), dates-2)))
    climato.v_ivt<- stackApply(b.v_ivt[[ids]], rep(1,length(ids)), mean, na.rm=F)
    mean.v_ivt <- mean.v_ivt - climato.v_ivt
    df.v_ivt <- cbind(xyFromCell(mean.v_ivt, 1:ncell(mean.v_ivt)), values(mean.v_ivt)) %>% data.frame()
    colnames(df.v_ivt) <- c("x", "y", "layer")

    yr=substr(date, 1,4); m.d=substr(date, 5, 10)
    yrs <- unique(substr(names(b.u_ivt), 2,5))
    dates <- sapply(paste0("X",yrs[!yrs==yr],m.d),
                    function(x){which(names(b.u_ivt)==x)})
    ids <- sort(unique(union(union(dates,dates-1), dates-2)))
    b.ivt <- sqrt(b.v_ivt[[ids]]^2+ b.u_ivt[[ids]]^2)
    names(b.ivt) <- ids
    climato.ivt<- stackApply(b.ivt[[paste0("X",ids)]], rep(1,length(ids)), mean, na.rm=F)
    mean.ivt <- mean(sqrt(b.v_ivt[[c((dt-2))]]^2+ b.u_ivt[[c((dt-2))]]^2))
    mean.ivt <- mean.ivt - climato.ivt
    df.ivt <- cbind(xyFromCell(mean.ivt, 1:ncell(mean.ivt)), values(mean.ivt)) %>% data.frame()
    colnames(df.ivt) <- c("x", "y", "layer")

    # compute the IVT flux
    df.ivt.arrows <- cbind(df.ivt, layer1=df.u_ivt$layer, layer2=df.v_ivt$layer)
    df.ivt.arrows <- df.ivt.arrows[df.ivt.arrows$layer> quantile(df.ivt.arrows$layer, 0),]
    df.ivt.arrows$layer1 <- (df.ivt.arrows$layer1-mean(df.ivt.arrows$layer1))/(8*sd(df.ivt.arrows$layer1))
    df.ivt.arrows$layer2 <- (df.ivt.arrows$layer2-mean(df.ivt.arrows$layer2))/(8*sd(df.ivt.arrows$layer2))

    # create maps
      ck.sst = ck.sst + df.sst$layer
      ck.z  = ck.z + df.z$layer
      ck.wspd = ck.wspd + df.wspd$layer
      # ck.mslp = ck.mslp + df.mslp$layer
      ck.tcw = ck.tcw + df.tcw$layer
      ck.cyclone = ck.cyclone + df.cyclone$layer
      ck.pv = rowSums( cbind (ck.pv, df.pv$layer), na.rm=TRUE)
      ck.blocks = ck.blocks + df.blocks$layer
      ck.u_ivt = ck.u_ivt + df.u_ivt$layer
      ck.v_ivt = ck.v_ivt + df.v_ivt$layer
      ck.ivt = ck.ivt + df.ivt$layer

    print(date)
   }

    ck.df.sst = data.frame( x=df.sst$x, y=df.sst$y, layer=ck.sst/nrow(ck.events))
    ck.df.z  = data.frame( x=df.z$x, y=df.z$y, layer=ck.z/nrow(ck.events))
    ck.df.wspd = data.frame( x=df.wspd$x, y=df.wspd$y, layer=ck.wspd/nrow(ck.events))
    ck.df.tcw = data.frame( x=df.tcw$x, y=df.tcw$y, layer=ck.tcw/nrow(ck.events))
    ck.df.cyclone = data.frame( x=df.cyclone$x, y=df.cyclone$y, layer=ck.cyclone/nrow(ck.events))
    ck.df.pv = data.frame( x=df.pv$x, y=df.pv$y, layer=ck.pv/nrow(ck.events))
    ck.df.blocks = data.frame( x=df.blocks$x, y=df.blocks$y, layer=ck.blocks/nrow(ck.events))
    # ck.df.mslp = data.frame( x=df.mslp$x, y=df.mslp$y, layer=ck.mslp/nrow(ck.events))
    ck.df.u_ivt = data.frame( x=df.u_ivt$x, y=df.u_ivt$y, layer=ck.u_ivt/nrow(ck.events))
    ck.df.v_ivt = data.frame( x=df.v_ivt$x, y=df.v_ivt$y, layer=ck.v_ivt/nrow(ck.events))
    ck.df.ivt = data.frame( x=df.ivt$x, y=df.ivt$y, layer=ck.ivt/nrow(ck.events))
    # compute the IVT anomaly
    ck.df.ivt.arrows <- cbind(ck.df.ivt, layer1=ck.df.u_ivt$layer, layer2=ck.df.v_ivt$layer)
    ck.df.ivt.arrows <- ck.df.ivt.arrows[ck.df.ivt$layer> quantile(ck.df.ivt$layer, 0.5),]
    ck.df.ivt.arrows$layer1 <- (ck.df.ivt.arrows$layer1-mean(ck.df.ivt.arrows$layer1))/(8*sd(ck.df.ivt.arrows$layer1))
    ck.df.ivt.arrows$layer2 <- (ck.df.ivt.arrows$layer2-mean(ck.df.ivt.arrows$layer2))/(8*sd(ck.df.ivt.arrows$layer2))
    dtt=paste0('Atmospheric conditions anomalies in Morocco, averaged over "cluster ', ck,'" extreme events')
    source("C:/Users/abdelaziz.chaqdid/Desktop/Phd/scripts/maps.printer.r")
    maps.printer( ck.df.sst, ck.df.z, ck.df.wspd, ck.df.u_ivt, ck.df.v_ivt, ck.df.ivt, ck.df.ivt.arrows,
                  ck.df.tcw, ck.df.cyclone, ck.df.pv, ck.df.blocks, #ck.df.mslp,
                  dtt, less.is.more=T, xyc, ck)

  print(ck)
  anomalies.list[[ck]]<- list(ck.df.sst, ck.df.z, ck.df.wspd, ck.df.u_ivt, ck.df.v_ivt, ck.df.ivt, ck.df.ivt.arrows,
                              ck.df.tcw, ck.df.cyclone, ck.df.pv, ck.df.blocks, dtt, less.is.more=T, xyc, ck)
}
write_rds("anomalies.list.rds")
anomalies.list <- readRDS("anomalies.list.rds")
```

Identify significant anomalies  

```{r}
# get the extreme events' dates 
events <- read.csv("D:/Phd/data/events/datailed.events.cluster.5k.csv", header = T, sep=",")
events <- events[-which(as.Date(events$date, format="%Y.%m.%d") >as.Date("2018-12-31")),] 

# get the file names of the variables
setwd("D:/Phd/data")
ncfnames <- list.files("ERA5 reanalysis for extreme precipitation")
ncfnames <- paste0("ERA5 reanalysis for extreme precipitation/", ncfnames)

# compute variable masks
for (ck in 1:5) {
  dates <- as.Date(events$dates[events$cluster==ck], format = "%Y.%m.%d") 
  cluster.mask <- list()
  vari = c(1, 9, 8, 4, 2, 3, 6, 7)
  gc()
  setwd("D:/Phd/data")
  for ( s in 1:length(vari)) {
    if(vari[s]==4){
      ivt.data <-  readRDS("ivt.data.rds")
      lonZ = ivt.data[[1]]; latZ = ivt.data[[2]]; data = ivt.data[[3]]; dVec = ivt.data[[4]]
    }else{
      # Open variable data file
      file <- nc_open(ncfnames[[vari[s]]])
      varnames <- names(file$dim)
      lonZ <- ncvar_get(file, varnames[-which(varnames=="time")][1])
      latZ <- ncvar_get(file, varnames[-which(varnames=="time")][2])
      data <- ncvar_get(file, names(file$var))
      dVec <- seq.Date(as.Date('1979-1-1'), length.out = dim(data)[3],by='day')
      nc_close(file)
    }
    
    # Calculate day of the year (1 to 366)
    doyVec = yday(dVec)

    # Loop on observed event dates
    ids_event <- c(sapply(which(dVec %in% dates), function(x){x + (-2:0)}))
    mean_event <- apply(data[,,ids_event], c(1,2), mean, na.rm=T)
  
    # Random DoY draw (+/- 10 calendar days around days of observed events)
    draw_doy <- doyVec[which(dVec%in%as.Date(dates))]
    for (j in c((-12):(-3),1:10)){
      draw_doy <- c(draw_doy,doyVec[which(dVec%in%as.Date(dates))+j])
    }
    
    # Significance
    N=2000
    matMC <- array(0,c(length(lonZ),length(latZ),N))
    for (i in 1:N){
      # To make sure all events are separated
      doy <- sample(draw_doy,length(dates),replace=F)
      yr <- sample(1979:2020,length(dates),replace=F) # replace=T if you have more than 42 observed events
      inds <- NULL
      for (u in 1:length(doy)){
        ind <- which(doyVec==doy[u] & year(dVec)==yr[u])
        if(length(ind)!=0){ inds <- c(inds, ind)}
      }
      ids_g.event <- c(sapply(which(dVec %in% dVec[inds]), function(x){x + (-2:0)}))
      ids_g.event <- ids_g.event[ids_g.event>0]
      matMC[,,i] <- apply(data[,,ids_g.event], c(1,2), mean, na.rm=T)
    }
    
    # #  eliminate very low frequencies 
    # mean_event <- mean_event/100
    # mean_event[mean_event==0] <- NA
    # for (i in 1:dim(matMC)[3]) {
    #   matMC[,,i] <- matMC[,,i]/100
    # }
    # 
    
    # Find rank of observed anomaly in MC sample
    mean_event[which(mean_event < 0.01*max(mean_event))] <- NA 
    matRk <- 0*mean_event
    for (i in 1:nrow(mean_event)){
      for (j in 1:ncol(mean_event)){
        if( is.na(mean_event[i,j]) ){ matRk[i,j] <- NA }else{
          matRk[i,j] <- rank(c(mean_event[i,j], matMC[i,j,]), ties.method = "last")[1]
        }
        matRk[i,j] <- sum(abs(matMC[i,j,]) < abs(anom_event[i,j]))
      }
    }
    
    # Get FDR significance mask
    p <- 2*(2000/2-abs(ceiling(matRk)-(2000/2+1)))/(2000+1)
    p[p<0] <- 0
    x <- p.adjust(c(p),method='fdr')
    mask <- 1*(matrix(x,nrow=nrow(p),byrow=F)<=0.1)
    rownames(mask) <- lonZ
    colnames(mask) <- latZ
    mask <- reshape2::melt(mask)
    colnames(mask) <- c("x", "y", "layer")
    cluster.mask[[s]] <-  mask
    print(s)
  }
  print(ck)
  setwd("D:/Phd/data/masks")
  write_rds(cluster.mask, paste0("cluster", ck, "mask.rds"))
}
```

Plot maps 

```{r}
# max and min of the clorbar
maxs = rep(NA,11)
setwd("D:/Phd/data")
anomalies.list <- readRDS("anomalies.list.rds")
for (ck in 1:5) {
  ck.anomalies <- anomalies.list[[ck]]
  for (var in 1:11) {
    maxs[var] <- max(maxs[var], max(abs(ck.anomalies[[var]][,3]), na.rm=T), na.rm=T)
  }
}

# clusters, Morocco, and continents boundaries 
xyc = list()
for (ck in 1:5) {
  p= readOGR("D:/Phd/data/clusters shepfile/", paste0("cluster",ck))
  ## start here for polys
  lin <- as(p, "SpatialLinesDataFrame")  
  #2. convert to matrix 
  mpts <- raster::geom(p)
  #3. convert to data frame
  dpts <- ggplot2::fortify(p)
  colnames(dpts) <- c("x",  "y",   "order", "hole",  "piece", "id",    "group")
  #4. convert to data frame
  xyc[[ck]]=dpts
}
maroc <- st_read("D:/Phd/data/Morocco")
countries <- st_read("D:/Phd/data/World_Continents")

# loading anomalies data 
setwd("D:/Phd/data")
anomalies.list <- readRDS("anomalies.list.rds")

# plot and save maps
vars= c(1,2,3,6,9,11, 10,8)
pv.plot <- list()
for (ck in 1:5) {
  var.mask <- readRDS(paste0("D:/Phd/data/masks/masks for 5 clusters/", paste0("cluster", ck, "mask.rds")))
  ck.anomalies <- anomalies.list[[ck]]
  for (var in 1:8) {
        Mask <- var.mask[[var]] %>% filter(layer==1) %>%  mutate(gpoint = paste0(x,"x",y)) %>%select(gpoint)
        tobe.masked <- ck.anomalies[[vars[var]]] %>% mutate(gpoint = paste0(x,"x",y)) %>% select(gpoint)
        inds <- which((tobe.masked$gpoint %in% Mask$gpoint)==FALSE)
        ck.anomalies[[vars[var]]]$layer[inds] <- NA
  }
  # compute significant arrows for ivt
  Mask <- var.mask[[4]] %>% filter(layer==1) %>%  mutate(gpoint = paste0(x,"x",y)) %>% select(gpoint)
  tobe.masked <- ck.anomalies[[7]] %>% mutate(gpoint = paste0(x,"x",y)) %>% select(gpoint)
  inds <- which((tobe.masked$gpoint %in% Mask$gpoint)==FALSE)
  ck.anomalies[[7]]$layer1[inds] <- NA
  ck.anomalies[[7]]$layer2[inds] <- NA
  # mask irrelevent anomalies of blocking and cyclone frequency
  
  print("here1")
  ck.df.sst = ck.anomalies[[1]]; ck.df.z= ck.anomalies[[2]]; ck.df.wspd= ck.anomalies[[3]];
  ck.df.u_ivt= ck.anomalies[[4]]; ck.df.v_ivt= ck.anomalies[[5]]; ck.df.ivt= ck.anomalies[[6]]; 
  ck.df.ivt.arrows= ck.anomalies[[7]]; ck.df.tcw= ck.anomalies[[8]]; ck.df.cyclone= ck.anomalies[[9]]; 
  ck.df.pv= ck.anomalies[[10]]; ck.df.blocks= ck.anomalies[[11]]; dtt= ck.anomalies[[12]]; 
  less.is.more= ck.anomalies[[13]]; xyc= ck.anomalies[[14]]; ck = ck.anomalies[[15]] 
  ck.df.ivt.arrows$layer1 <- ck.df.ivt.arrows$layer1/2
  ck.df.ivt.arrows$layer2 <- ck.df.ivt.arrows$layer2/2

  # mask unsignificant anomalies
  if(length(ck.df.sst$layer[!is.na(ck.df.sst$layer)])>1){ 
      ck.df.sst$layer[!is.na(ck.df.sst$layer)] <- ck.df.sst$layer[!is.na(ck.df.sst$layer)] * var.mask[[1]]$layer
  }
  
  ck.means.list <- means.list[[ck]]
  PV.2pvu <- ck.means.list[[2]]
  PV.2pvu.mean <- ck.means.list[[3]]
  jetstream <- ck.means.list[[1]]
  print("here2")
  setwd("D:/Phd/data/masks")
  pv.plot [[ck]] <- maps.printer( ck.df.sst, ck.df.z, ck.df.wspd, ck.df.u_ivt, ck.df.v_ivt, ck.df.ivt, ck.df.ivt.arrows,
                ck.df.tcw, ck.df.cyclone, ck.df.pv, ck.df.blocks,
                dtt, xyc, ck, maxs, PV.2pvu, PV.2pvu.mean, jetstream, countries)

print(ck)
} 

# grouping PV maps in one Figure
all.plots <- ggarrange(pv.plot[[1]], pv.plot[[2]], pv.plot[[3]], pv.plot[[4]],
                       pv.plot[[5]], common.legend = T, nrow = 2, ncol = 3, legend = "bottom")
ggsave("PV_anomalies.pdf", all.plots, width=20, height=12, units="cm", dpi = 800, device=cairo_pdf)

```

#### Seasonal distribution of cyclones origins in each region

```{r}
#load cyclones data
setwd("D:/Phd/data")
anomalies.list <- readRDS("anomalies.list.rds")
cyclones <- brick("WS06.era5.1deg.1979-2018.nc", "Cyclone")

# load extreme event dates 

  library(tidyverse)
  events <- read.csv("D:/Phd/data/extreme_events_morocco_3day_totals.csv", header = T, sep=",")
  events <- events[-which(as.Date(events$date, format="%Y.%m.%d") >as.Date("2018-12-31")),] 
  ex.events <- NULL
  for (ck in 1:5) {
    ex.events <- rbind(ex.events, events %>% filter(cluster==ck) %>% arrange(desc(area)) %>% head(20))
  }
  ex.events %>% group_by(cluster) %>% summarise(n=n())
  event_dates <- ex.events %>% mutate(date=as.Date(date, format="%Y.%m.%d")) %>% select(cluster, date)
  
# extract the cyclone data for each event 
  
  dtt <- as.Date(substr(names(cyclones), 2, 9), format="%Y%m%d")
  ck.cyclones = list() 
  for (ck in 1:5) {
    i=1
    evs <- as.character(event_dates$date[event_dates$cluster==ck])
    for (ev in evs){
      if(i==1){
        ev.cyclones <- cyclones[[which(dtt %in% (as.Date(ev)-9:0))]]; i=i+1
      }else{
        ev.cyclones <- stack(ev.cyclones, cyclones[[which(dtt %in% (as.Date(ev) -9:0))]])
      }
    }
    ck.cyclones[[ck]] <-  ev.cyclones
  }

# computes the initial position of cyclones 

  for (ck in 1:5) {
    cyclones.trajects <- data.frame(region=0, event=0, x=0, y=0, cyclone=0)
    xyc <-anomalies.list[[ck]][[14]]
    ext <- extent( min(xyc$x)-1, max(xyc$x)+1, min(xyc$y)-1, max(xyc$y)+1 )
    xy <-  (rasterToPoints(crop(ck.cyclones[[ck]][[1]], ext)) %>% data.frame())[,c(1,2)]
    ck.evs <- as.character(event_dates[event_dates$cluster==ck,2])
    ck.evs <- ck.evs[!ck.evs<=as.Date("1979-02-01")]
    ck.data = rasterToPoints(ck.cyclones[[ck]]) %>% data.frame()
    if(ck==4){n=2}else{n=1}
    for (ev in 0:(length(ck.evs)-n)) {
      ev.data <- ck.data[, c(c(1,2),c((1+(ev*4*10)):(4*10+(ev*4*10))+2))]
      inds <- intersect(which(ev.data$x %in% xy$x ), which(ev.data$y %in% xy$y) )
      modal.cyc <- apply(ev.data[inds,(4*10-12):(4*10)], 2, function(x){
        x.not0 <- x[x!=0]
        if(length(x.not0)){return(modal(x.not0))}else{return(0)}
        })
        if(sum(modal.cyc!=0)!=0){
          for (cyc in modal.cyc[modal.cyc!=0]) {
            cyc.occurence <- apply(ev.data[,-(1:2)], 2, function(x){any(x==cyc)})
            cyc.start <- which(cyc.occurence==T)[1] +2
            cyc.info <- cbind(ck, ck.evs[ev+1], ev.data[ev.data[,cyc.start]==cyc,1:2], cyc)
            names(cyc.info) <- c("region", "event", "x", "y", "cyclone")
            cyclones.trajects <- rbind(cyclones.trajects, cyc.info)
          }
        }
      print(ev)
    }
    setwd("D:/Phd/data")
    write.csv(cyclones.trajects,  paste0("cyclones.trajectories.region_",ck, ".csv"))
  }


# add the season and direction of cyclones
  
  # the geographical center of each cluster
  centers <- data.frame(x = c(-5.5, -3.5,-8.5, -6.5, -13),
                        y = c(34, 33.3,32, 30.3, 26))
  
  # dir_degree function computes the direction using long and lat 
  dir_degree <- function(x, y, x0, y0){
    res=NULL
    for (i in 1:length(x)) {
      
      aTN <- atan((x[i]-x0)/(y[i]-y0))*180/pi 
      
      if(x[i]==x0 & y[i]==y0){res<- c(res,NA)}
      
      if(x[i]>=x0 & y[i]>y0){res<- c(res,0 + abs(aTN))} # first quadrant
    
      if(x[i]<x0 & y[i]>=y0){res<- c(res,90*3  + abs(aTN))} # second quadrant
      
      if(x[i]<=x0 & y[i]<y0){res<- c(res,90*2  + abs(aTN))} # third quadrant
      
      if(x[i]>x0 & y[i]<=y0){res<- c(res,90*1  + abs(aTN))} # fourth quadrant
    
    }
    return(res)
  }
  # check
  dir_degree(-9, 13, -13, 26)
  dir_degree(-11, 24, -13, 26)
  dir_degree(-11, 28, -13, 26)
  dir_degree(-15, 24, -13, 26)
  dir_degree(-15, 28, -13, 26)

  cyclones.Morocco <- NULL
  for (ck in 1:5) {
    x0=centers[ck,1]; y0= centers[ck,2];
    setwd("D:/Phd/data")
    cyclones.trajects <- read.csv(paste0("cyclones.trajectories.region_",ck, ".csv"))
    cyclones.trajects <- cyclones.trajects %>% filter(region==ck)
    df.points<- cyclones.trajects%>%mutate(Season=season(as.Date(event)), 
                                           Angle= dir_degree(x, y, x0, y0))
    cyclones.Morocco <- rbind(cyclones.Morocco, df.points)
  }
  setwd("D:/Phd/data")
  write.csv(cyclones.Morocco,  "cyclones.30event.Morocco.csv")
  cyclones.Morocco <- read.csv("cyclones.30event.Morocco.csv")

# prepare data to create cyclone roses 
  cyclones.Morocco <- cyclones.Morocco[!is.na(cyclones.Morocco$Angle),]
  cyc.rose.data <- data.frame(region=0, event=0, Season="s", cyc.dir=0, cyclone=0)
  for (ck in 1:5) {
    ck.cyclones.df <- cyclones.Morocco[cyclones.Morocco$region==ck,]
    id.cycl <- unique(ck.cyclones.df[,"cyclone"])
    for (cyc in id.cycl) {
      mean.dir <- mean(ck.cyclones.df[ck.cyclones.df$cyclone==cyc, "Angle"])
      dt <- unique(ck.cyclones.df[ck.cyclones.df$cyclone==cyc, "event"])[1]
      sn <- unique(ck.cyclones.df[ck.cyclones.df$cyclone==cyc, "Season"])[1]
      cyc.rose.data <- rbind(cyc.rose.data, c(ck, dt, sn, mean.dir, cyc))
    }
    
  }
  cyc.rose.data <- cyc.rose.data[-c(1),]
  
# cluster mean direction of cyclones to directions spaced by 10Â° 
  cyc.rose.data <- data.frame(cyc.rose.data, Numb =1)
  cyc.rose.data$cyc.dir <- as.numeric(cyc.rose.data$cyc.dir)
  
  cyc.rose.data <- cyc.rose.data %>% mutate( rounded.dir = case_when(
    (0<cyc.dir & cyc.dir<=30) ~ 30,
    (30<cyc.dir & cyc.dir<=60) ~ 60,
    (60<cyc.dir & cyc.dir<=90) ~ 90,
    (90<cyc.dir & cyc.dir<=120) ~ 120,
    (120<cyc.dir & cyc.dir<=150) ~ 150,
    (150<cyc.dir & cyc.dir<=180) ~ 180,
    (180<cyc.dir & cyc.dir<=210) ~ 210,
    (210<cyc.dir & cyc.dir<=240) ~ 240,
    (240<cyc.dir & cyc.dir<=270) ~ 270,
    (270<cyc.dir & cyc.dir<=300) ~ 300,
    (300<cyc.dir & cyc.dir<=330) ~ 330,
    (330<cyc.dir & cyc.dir<=360) ~ 360,
  ))
  

  # encoding season 
  cyc.rose <- cyc.rose.data %>% mutate(num.season= case_when(
    Season == "DJF" ~ 1,
    Season == "MAM" ~ 2,
    Season == "JJA" ~ 3,
    Season == "SON" ~ 4,
))
  
  setwd("D:/Phd/data/the_10days_before")
  pdf("cyclone.frequency.morocco.pdf", width=8, height=6)
  
  cyc.rose$region <- paste("Region",cyc.rose$region)

  windRose(cyc.rose, ws = "num.season", wd = "rounded.dir",
           paddle = F, border = T,angle = 45,
           breaks = c(0,1, 2, 3, 4),
           key = list(labels = c("DJF", "MAM", "JJA", "SON")),
           type = 'region',
           grid.line = 10, # show grid line each 10%,
           annotate = T,
           key.footer = "Geographical distribution and origins of cyclones in Morocco by season",
           col=c(  "#594F4F","#45ADA8", "#E5FCC2" ,  "#547980"))
  dev.off()
  
  setwd("D:/Phd/data/the_10days_before")
  ggsave(paste0("cyclones_in_region",ck,".jpg"),p, units="cm", width=30, height=12, dpi=800 )

```

#### Related functions 

Slice dataframe to different subsets with homogeneous periods 
```{r}
  slice.data <- function(x){
    library(plyr)
    j=x[1,3]
    ids.list=list()
    aux=x[1,]
    for (i in 2:nrow(x)) {
      k=x[i,3]
      if(k==j){
        aux= rbind.fill(aux, x[i,])
      }else{
        ids.list[[i]] = aux
        aux = x[i,]
      }
      j=k
    }
    ids.list[[i]] = aux
    ids.list <- ids.list[which(sapply(ids.list, length)!=0)]
    return(ids.list)
    detach("package:plyr")   
  }
```
Ploting atmospheric anomalies 
```{r}
maps.printer <- function( df.sst, df.Z500, df.wspd, df.u_ivt, df.v_ivt, df.ivt, df.ivt.arrows,
                          df.tcw, df.cyclone, df.pv, df.blocks, dtt, xyc, ck, maxs, PV.2pvu, 
                          PV.2pvu.mean, jetstream, countries){
  
  # Adjusting the ploting panel
  Xlim= c(-45,20)
  Ylim= c(15,55)
  new.theme <- theme_minimal_grid() +
    theme(legend.position = "bottom",
          legend.text = element_text(size=6, angle=(45)), 
          legend.title = element_text(vjust = 0, size=10),
          legend.margin = margin(-50,-50,-50,-50),
          legend.spacing.y = unit(0.22, 'cm'),
          legend.box.spacing =unit(0.15, 'cm'),  
          legend.box.margin = margin(-80,-80,-80,-80),
          legend.key.size = unit(0, 'cm'),
          axis.ticks = element_blank(),
          axis.text = element_blank(), 
          plot.title = element_text(hjust = 0, size=12, face="plain"),
          legend.justification = "center",
          panel.border = element_rect(colour = "black", fill=NA, size=0.2),
          panel.grid.major = element_line(colour = "lightgrey", size = 0.05),
          panel.grid.minor =  element_line(colour = "lightgrey", size = 0.05) ) 
  theme_set(new.theme)
    if(ck==2){
      
    # Cyclone anomalies 
    colbr <- c(paletteer_d("RColorBrewer::PuOr")[1:5],"white", paletteer_d("RColorBrewer::PiYG")[7:11])
    lim=maxs[9]
    cyclone.plot <-  ggplot(df.cyclone)+
      geom_raster(aes(x,y,fill=layer), interpolate = TRUE, alpha=1)+
      geom_sf(data=countries, fill= NA, size=0.1, color="#636363") +
      geom_sf(data=maroc,fill=NA,size=0.3, colour="black")+
      geom_point(data=xyc, aes(x=x, y=y), colour="black", size = 0.3)+
      scale_fill_gradientn(colours=rev(colbr), 
                           breaks =  seq(-lim, lim,length.out=9),
                           labels =  round(seq(-lim, lim,length.out=9),2),
                           na.value = "white",
                           limits= c(-lim, lim),
                           guide = guide_colorbar(  nbin = 9,
                                                    barwidth = 9.75,
                                                    barheight = 0.5,
                                                    title.position = "bottom",
                                                    title.hjust = 0.5, 
                                                    raster = FALSE, 
                                                    ticks = T,
                                                    frame.colour = "black", frame.linewidth = 1)) +
      coord_sf(xlim = Xlim, ylim = Ylim)+
      labs(x="",y="",fill=expression(paste("Cyclone anomaly [1/day]")), title = "e) ")+
      theme(panel.ontop = T)
    ggsave(paste0("cyclone.cluster",ck,".jpg"), units="cm", width=10, height=10, dpi=800 )
    
  }else{
    # Cyclones anomaloies 
    colbr <- c(paletteer_d("RColorBrewer::PuOr")[1:5],"white", paletteer_d("RColorBrewer::PiYG")[7:11])
    lim=maxs[9]
    cyclone.plot <-  ggplot(df.cyclone)+
      geom_contour_fill(aes(x , y, z = layer), 
                        na.fill = "white", bins = 6, global.breaks=F) +
      scale_fill_gradientn(colours = rev(colbr), breaks =  seq(-lim, lim,length.out=9),
                           labels =  round(seq(-lim, lim,length.out=9),2),
                           na.value = "white",
                           limits= c(-lim, lim),
                           guide = guide_colorbar(  nbin = 9,
                                                    barwidth = 9.75,
                                                    barheight = 0.5,
                                                    title.position = "bottom",
                                                    title.hjust = 0.5, 
                                                    raster = FALSE, 
                                                    ticks = T,
                                                    frame.colour = "black", frame.linewidth = 1)) +
      geom_sf(data=countries, fill= NA, size=0.1, color="#636363") +
      geom_sf(data=maroc,fill=NA,size=0.3, colour="black")+
      geom_point(data=xyc, aes(x=x, y=y), colour="black", size = 0.3)+
      coord_sf(xlim = Xlim, ylim = Ylim)+
      labs(x="",y="",fill=expression(paste("Cyclone anomaly [1/day]")), title = "e) ")
    ggsave(paste0("cyclone.cluster",ck,".jpg"), units="cm", width=10, height=10, dpi=800 )
    
  }
  
  # blocking anomalies 
  colbr <- paletteer_c("ggthemes::Red-Green-White Diverging", 30)
  lim=maxs[11]
  blocks.plot <-  ggplot(df.blocks)+
    geom_raster(aes(x,y,fill=layer), interpolate = TRUE, alpha=1)+
    geom_sf(data=countries, fill= NA, size=0.1, color="#636363") +
    geom_sf(data=maroc,fill=NA,size=0.3, colour="black")+
    geom_point(data=xyc, aes(x=x, y=y), colour="black", size = 0.3)+
    scale_fill_gradientn(colours=rev(colbr), 
                         breaks = seq(-lim, lim,length.out=9),
                         labels =  round(seq(-lim, lim,length.out=9),2),
                         na.value = "white",
                         limits= c(-lim, lim),
                         guide = guide_colorbar(  nbin = 9,
                                                  barwidth = 9.75,
                                                  barheight = 0.5,
                                                  title.position = "bottom",
                                                  title.hjust = 0.5, 
                                                  raster = FALSE, 
                                                  ticks = T,
                                                  frame.colour = "black", frame.linewidth = 1)) +
    coord_sf(xlim = Xlim, ylim = Ylim)+
    labs(x="",y="",fill=expression(paste("Blocking anomaly [1/day]")), title = "f) ")+
    theme(panel.ontop = T)
  ggsave(paste0("block.cluster",ck,".jpg"), units="cm", width=10, height=10, dpi=800 )

  # IVT anomalies 
  colbr <- paletteer_c("grDevices::Green-Brown", 30)
  lim=maxs[6]
  ivt.plot <-  ggplot(df.ivt)+
    geom_contour_fill(aes(x , y, z = layer), 
                      na.fill = "white", bins = 5, global.breaks=F) +
    scale_fill_gradientn(colours = rev(colbr), breaks = seq(-lim, lim,length.out=11),
                         labels =  round(seq(-lim, lim,length.out=11)),
                         na.value = "white",
                         limits= c(-lim, lim),
                         guide = guide_colorbar(  nbin = 11,
                                                  barwidth = 9.75,
                                                  barheight = 0.5,
                                                  title.position = "bottom",
                                                  title.hjust = 0.5, 
                                                  raster = FALSE, 
                                                  ticks = T,
                                                  frame.colour = "black", frame.linewidth = 1)) +
    geom_sf(data=countries, fill= NA, size=0.1, color="#636363") +
    geom_sf(data=maroc,fill=NA,size=0.3, colour="black")+
    geom_point(data=xyc, aes(x=x, y=y), colour="black", size = 0.3)+
    coord_sf(xlim = Xlim, ylim = Ylim)+
    metR::geom_vector(data = df.ivt.arrows, aes(x = x, y = y, dx = layer1, dy = layer2), 
                      arrow.angle = 30, arrow.type = "open", arrow.length = .14, size=0.2,
                      pivot = 0,preserve.dir = TRUE, skip.x = 3,
                      skip.y = 3)+
    labs(x="",y="",fill=expression(paste("IVT anomaly [Kg/(ms)]")), title = "b) ")
  ggsave(paste0("ivt.cluster",ck,".jpg"), units="cm", width=10, height=10, dpi=800,)
  
  # PV anomalies 
  colbr <- paletteer_c("ggthemes::Red-Green-White Diverging", 30)
  lim=maxs[10]
  pv.plot <-  ggplot(df.pv)+
    geom_contour_fill(aes(x , y, z = layer), 
                      na.fill = "white", bins = 6, global.breaks=F) +
    scale_fill_gradientn(colours = rev(colbr), breaks =  seq(-lim, lim,length.out=9),
                         labels= round(seq(-lim, lim,length.out=9),1),
                         na.value = "white",
                         limits= c(-lim, lim),
                         guide = guide_colorbar(  nbin = 9,
                                                  barwidth = 9.75,
                                                  barheight = 0.5,
                                                  title.position = "bottom",
                                                  title.hjust = 0.5, 
                                                  raster = FALSE, 
                                                  ticks = T,
                                                  frame.colour = "black", frame.linewidth = 1)) +
    geom_sf(data=countries, fill= NA, size=0.1, color="#636363") +
    geom_sf(data=maroc,fill=NA, size=0.3, colour="black")+
    geom_point(data=xyc, aes(x=x, y=y), colour="black", size = 0.3)+
    geom_contour(data=PV.2pvu, aes(x=x, y=y, z=layer), colour="blue", size = 0.5, bins = 1, breaks = c(2))+
    geom_contour(data=PV.2pvu.mean, aes(x=x, y=y, z=layer), linetype = "dashed", colour="blue", size = 0.5,bins = 1, breaks = c(2))+
    coord_sf(xlim = c(-75,30) , ylim = c(15,65))+
    labs(x="",y="",fill=expression(paste("[PVU]")), title = paste0('320K PV anomaly for Region "', ck, '"'))
  ggsave(paste0("pv.cluster",ck,".jpg"), units="cm", width=10, height=9, dpi=800 )
  
  # TCW anomalies 
  colbr <- paletteer_c("grDevices::BrBG", 30)
  lim=maxs[8]
  tcw.plot <-  ggplot(df.tcw)+
    geom_contour_fill(aes(x , y, z = layer), 
                      na.fill = "white", bins = 6, global.breaks=F) +
    scale_fill_gradientn(colours = colbr, breaks = seq(-lim, lim,length.out=9),
                         labels =  round(seq(-lim, lim,length.out=9)),
                         na.value = "white",
                         limits= c(-lim, lim),
                         guide = guide_colorbar(  nbin = 9,
                                                  barwidth = 9.75,
                                                  barheight = 0.5,
                                                  title.position = "bottom",
                                                  title.hjust = 0.5, 
                                                  raster = FALSE, 
                                                  ticks = T,
                                                  frame.colour = "black", frame.linewidth = 1)) +
    geom_sf(data=countries, fill= NA, size=0.1, color="#636363") +
    geom_sf(data=maroc,fill=NA, size=0.3, colour="black")+
    geom_point(data=xyc, aes(x=x, y=y), colour="black", size = 0.3)+
    coord_sf(xlim = Xlim, ylim = Ylim)+
    labs(x="",y="",fill=expression(paste("TCW anomaly [Kg/m2]")), title = "c) ")
  ggsave(paste0("tcw.cluster",ck,".jpg"), units="cm", width=10, height=10, dpi=800 )
  
  # Wind speed anomalies
  colbr <- paletteer_c("ggthemes::Orange-Blue-White Diverging", 30)
  if(ck!=4){jetstream <- jetstream %>% filter(x<=25 & x>=-50) %>% filter(y<=60 & y>=10)}else{
    jetstream <- jetstream %>% filter(x<=25 & x>=-50) %>% filter(y<=60 & y>=10)
  }
  lim=maxs[3]
  wspd.plot <-  ggplot(df.wspd)+
    geom_contour_fill(aes(x , y, z = layer), 
                      na.fill = "white", bins = 6, global.breaks=F) +
    scale_fill_gradientn(colours = rev(colbr), breaks =  seq(-lim, lim,length.out=9),
                         labels =  round(seq(-lim, lim,length.out=9)),
                         na.value = "white",
                         limits= c(-lim, lim),
                         guide = guide_colorbar(  nbin = 9,
                                                  barwidth = 9.75,
                                                  barheight = 0.5,
                                                  title.position = "bottom",
                                                  title.hjust = 0.5, 
                                                  raster = FALSE, 
                                                  ticks = T,
                                                  frame.colour = "black", frame.linewidth = 1)) +
    geom_sf(data=countries, fill= NA, size=0.1, color="#636363") +
    geom_sf(data=maroc,fill=NA, size=0.3, colour="black")+
    geom_point(data=xyc, aes(x=x, y=y), colour="black", size = 0.3)+
    geom_contour(data=jetstream, aes(x,y,z=layer),size =0.4, colour="#636363", binwidth = 10, linetype = "dashed")+
    geom_text_contour(data=jetstream, aes(x, y, z = layer), binwidth=10, size=2,  stroke = 0.18, stroke.colour = "white", skip = 0)+
    coord_sf(xlim = Xlim, ylim = Ylim)+
    labs(x="",y="",fill=expression(paste("Wind speed anomaly [m/s]")), title = "d) ")
  ggsave(paste0("w200.cluster",ck,".jpg"), units="cm", width=10, height=10, dpi=800 )
  
  # geopotential anomalies 
  colbr <- paletteer_c("grDevices::RdBu", 30)
  lim=maxs[2]
  z.plot <-  ggplot(df.Z500)+
    geom_contour_fill(aes(x , y, z = layer), 
                      na.fill = "white", bins = 6, global.breaks=F) +
    coord_cartesian(expand = FALSE) + 
    scale_fill_gradientn(colours = rev(colbr), breaks =  seq(-lim, lim,length.out=9),
                         labels=  round(seq(-lim, lim,length.out=9)),
                         na.value = "white",
                         limits= c(-lim, lim),
                         guide = guide_colorbar(  nbin = 9,
                                                  barwidth = 9.75,
                                                  barheight = 0.5,
                                                  title.position = "bottom",
                                                  title.hjust = 0.5, 
                                                  title.vjust=0,
                                                  raster = FALSE, 
                                                  ticks = T,
                                                  frame.colour = "black", frame.linewidth = 1)) +
    labs(x="",y="", fill= "Geopotential anomaly [m]", title = "a) ")+
    geom_sf(data=countries, fill= NA, size=0.1, color="#636363") +
    geom_sf(data=maroc,fill=NA,size=0.3, colour="black")+
    geom_point(data=xyc, aes(x=x, y=y), colour="black", size = 0.3)+
    coord_sf(xlim = Xlim, ylim = Ylim)
  ggsave(paste0("Z500.cluster",ck,".jpg"), units="cm", width=10, height=10, dpi=800 )
  
  # clusters with some differences
  if(ck!=3){
    blocks.plot <- blocks.plot 
    all.plots <-(z.plot|ivt.plot|tcw.plot)/(wspd.plot|cyclone.plot|blocks.plot)
    ggsave(paste0("Anomalies_for_cluster",ck,".pdf"), all.plots, width=19, height=14, units="cm", dpi = 800, device=cairo_pdf)

    }else{
      Xlim= c(-75,30) 
      Ylim= c(15,65)
      colbr <- paletteer_c("ggthemes::Red-Green-White Diverging", 30)
      lim=maxs[11]
      blocks.plot <-  ggplot(df.blocks)+
        geom_raster(aes(x,y,fill=layer), interpolate = TRUE, alpha=1)+
        geom_sf(data=countries, fill= NA, size=0.1, color="#636363") +
        geom_sf(data=maroc,fill=NA,size=0.3, colour="black")+
        geom_point(data=xyc, aes(x=x, y=y), colour="black", size = 0.3)+
        scale_fill_gradientn(colours=rev(colbr), 
                             breaks = seq(-lim, lim,length.out=9),
                             labels =  round(seq(-lim, lim,length.out=9),2),
                             na.value = "white",
                             limits= c(-lim, lim),
                             guide = guide_colorbar(  nbin = 9,
                                                      barwidth = 10,
                                                      barheight = 0.5,
                                                      title.position = "bottom",
                                                      title.hjust = 0.5, 
                                                      raster = FALSE, 
                                                      ticks = T,
                                                      frame.colour = "black", frame.linewidth = 1)) +
        coord_sf(xlim = Xlim, ylim = Ylim)+
        labs(x="",y="",fill=expression(paste("Blocking anomaly [1/day]")), title = "f) ")+
        theme(panel.ontop = T)

      all.plots <-(z.plot|ivt.plot|tcw.plot)/(wspd.plot|cyclone.plot|blocks.plot)
      ggsave(paste0("Anomalies_for_cluster",ck,".pdf"), all.plots, width=19, height=14, units="cm", dpi = 800, device=cairo_pdf)

    }
  return(pv.plot)
}

```

Plot the clusters 
```{r}
 plot.hclust <- function(Start, End) {
   setwd("D:/Phd/data")
   clusters= cutree(donn.class,k=End) # computing the silhouette coeff
   clusters[which(clusters==6)] <- 5
   xyz= data.frame(x=longitudes, y=latitudes, z= clusters)
   # for (K in Start:End) {
      # plotting the clusters over the French map
        # for (ck in 1:6) {
        # xyc= xyz %>% filter(z==ck)
        # r<- rasterFromXYZ(xyc)
        # crs(r) <- "+proj=longlat +datum=WGS84 +no_defs"
        # rtp <- rasterToPolygons(r,fun=function(x){x==ck}, dissolve=T)
        # writeOGR(rtp, dsn = "D:/Phd/data/clusters shepfile/cluster6k" , layer = paste0("cluster", ck), driver = "ESRI Shapefile")
        # }
      colorK = c("#5AFF00", "#8E01FE", "#0096FF", "#FFFE33", "#E60002", "#848484")
      p<- ggplot(maroc)+
        xlab("Longitude") +
        ylab("Latitude") +
        theme(plot.title = element_text(hjust = 0.5), 
              panel.background = element_rect(fill = "white"))+
        geom_point(data= xyz, aes(x=x, y=y, colour=factor(z)), size=0.6,
                    shape=15)+
        scale_colour_manual(name="Regions", values=colorK)+
        geom_sf(fill=NA, size=0.5, color="black")+ theme_bw()
        
      # flood.list <- read.csv("moroccan_foods_list.csv", header = T, sep=";")
      # x.coord=NULL
      # y.coord=NULL
      # k=1
      # for(j in 1:nrow(flood.list)){
      #   x.coord[k]= flood.list[j,2]
      #   y.coord[k]= flood.list[j,3]
      #   k=k+1
      # }
      p1 <- p
      # p1 <- p + geom_point(data=data.frame(x=x.coord, y=y.coord, z= rep("floods",length(x.coord)) ),
      #                    aes(x=x, y=y, fill=z), color="white", size=1.8)+
      # scale_fill_manual(values="black") + labs(fill = "         ")
      
    
    return(p1)
  }
```
Plot probability maps 
```{r}
probability <- function(b.df, K, clusters){
  setwd("D:/Phd/data")
  library(caTools)
  library(rgeos)
  # prepare data (extreme precipitation =1 , non-extreme =0)
  data <- b.df %>% t
  for (i in 1:ncol(data)) {
    Q99  <- quantile(data[,i][data[,i]>1],0.99)
    extr <- which(data[,i]>Q99)
    data[,i] <- 0 ; data[extr,i] <- 1
  }
  Tdata <- data %>% data.frame %>%  mutate(DATE =substr(rownames(data), 2,11) %>% as.Date("%Y.%m.%d")) 
  
  data <- data.frame(t(data), cluster= clusters)
  C=1:K

    # hit rate based on ERA5 data
  P <- readRDS("ERA5.probabilities.6k.rds")
  # prepare latitudes and longitudes
  lat <- sapply(colnames(P[[1]]), function(x) { strsplit(x, "x")[[1]][3]})
  lat <- lat %>% as.numeric
  long <- sapply(colnames(P[[1]]), function(x) { strsplit(x, "x")[[1]][2]})
  long <- -(long%>% substr(2,nchar(long))%>%as.numeric)

  # map the average conditional probability
  Pj.mean=list()
  for (ck in C) {
    Pj.mean[[ck]] <- apply(P[[ck]][-c(1),], 2, function(x){mean(as.numeric(x))})
  }
  
  for (ck in 1:6) {Pj.mean[[ck]][Pj.mean[[ck]]<0] <-0 }
  
  pMAX =sapply(Pj.mean, max) %>% max
  pMIN =sapply(Pj.mean, min) %>% min
  p2 = list()
  for (ck in C) {
    xyz=data.frame(x=long, y=lat, z=Pj.mean[[ck]])
    xyz$vtitle <- paste0("Cluster  ", ck)
    # xyz$htitle <- "Reanalysis"
    p<-ggplot(xyz)+
          geom_sf(data= maroc, fill = NA, colour = "#420A68FF", size=1.5)+
          geom_raster(aes(x=x, y=y, fill=z))+
          binned_scale(aesthetics = "fill",
                         scale_name = "stepsn",
                         palette = function(x) c("#330A5FFF", "#781C6DFF", "#ED6925FF", "#FCB519FF", "#FCFFA4FF", "white"),
                         breaks = seq(0.1, 0.9, 0.2),
                         limits = c(0, 1),
                         show.limits = F,
                         guide = guide_colorbar(nbin = 6,
                                                barwidth = 16,
                                                barheight =0.4,
                                                title.position = "top",
                                                title.hjust = 0.5,
                                                raster = FALSE,
                                                ticks = T,
                                                ticks.colour = "black",
                                                frame.colour = "black",
                                                frame.linewidth = 1))+
            labs(fill="Probability")+theme_grey()+
            geom_polygon(data=xyc[[ck]], aes(x=x, y=y), fill=NA, colour="#C5C5C5", size = 0.8)+
            theme(legend.text = element_text(size=10),
                  legend.title = element_text(size=13),
                  plot.title = element_text(hjust = 0.5, size=12, face="plain"),
                  panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),
                  panel.background = element_blank(),
                  axis.text = element_blank(),
                  axis.ticks = element_blank(),
                  axis.title = element_blank(),
                  legend.position = "bottom",
                  legend.key.size = unit(0.1, 'cm'),
                  legend.key.width= unit(5, 'cm'),
                  strip.text.x = element_text(size = 11, face = "bold"),
                  strip.text.y = element_text(size = 11),
                  
                  )

    p2[[ck]] <- p + facet_grid(. ~ vtitle)

  }

  return(list(p2, p3))
}
```




